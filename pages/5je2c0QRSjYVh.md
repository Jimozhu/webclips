---
title: 架构设计-复用是邪恶的
date: 2024-07-22T04:24:54.406Z
categories:
  - webclip
tags:
  - webclip
origin_url: 'https://mp.weixin.qq.com/s/5N5munqAxg0B_avZWjVZNA'
---

![图片](https://mmbiz.qpic.cn/sz_mmbiz_jpg/sYwOgQTpxzIlEQlpbsXiapnVfOGK6uIicpkzsLiaN375R9w4US1WEIYwyWYVJflmzZnIKdHNxBPECaVvrszdUSKUQ/640?wx_fmt=jpeg\&from=appmsg\&tp=webp\&wxfrom=5\&wx_lazy=1\&wx_co=1)

在编写代码和进行架构设计时，我经常听到「复用」这个词。很多人在设计技术、业务和组织架构时，都会以「复用」为目标。例如：

* 抽象出一个类，函数，或 UI 组件，使其可以在不同的场景中使用。

* 抽象出许多微服务，越细越好，这样就可以像乐高一样灵活地组合。

* 抽象出业务中台，沉淀各种基础业务功能，供全公司使用。

* 在组织架构中，抽象出职能团队（如后端、前端、QA、财务等），使其服务于整个公司。

## 为什么我们喜欢复用，愿意复用？

* 提高效率：既然相似功能的代码已经存在，为什么还要自己造呢？直接拿来稍微改吧改吧就可以了，这样就可以做得更少，提升个人的生产效率。

* 软件必须被复用：软件天然容易被复用，而且必须容易被复用。被多次复用之后才能解决更多人的问题，创造更多的收入（不包含某些特定企业只给老板一个人开发的软件）。

* 接受的教育：工程师最熟悉的编程原则可能就是 DRY（Don't Repeat Yourself）；《设计模式》全名是 《可复用面向对象软件的基础》，都在强调复用。

* 人的本性：如果能复用之前的代码，只通过添加几个函数参数，添加几个 if 就能完成工作。为啥我要重新写一个，或者重构呢？从另一个角度看，工程师若能创造出被广泛复用的模块，也能为其简历增色不少。

## 我们默认「复用提高效率」，真的是这样吗？

认为复用可以提高效率的推理逻辑是怎样的？

* 写一个系统的所有代码需要大量时间和精力。如果能重用以前写过的代码，就能节省时间。
* 复用的代码越多，我们需要写的新代码就越少，从而更早完成系统。

这样的推理逻辑是存在如下误区

* 所有代码需要相同的时间来写：事实上，不同功能的复杂度和开发时间差异很大。
* 写代码是主要工作：实际上，理解和调试代码，特别是复用的代码，往往更耗时。

在实际业务开发中，复用很多模块意味着需要理解这些模块的接口和功能。仅靠文档往往不够，你可能需要深入代码，咨询依赖模块的开发者。这不仅增加了沟通成本，还可能导致效率降低。此外，抽象公共业务模块时缺乏标准，往往会导致这些模块变成「外包」，降低整体效率。

研发人员都知道，编写代码只是整个工作中的一小部分，而且是确定性最高的一部分。实际上，方案设计和维护才是最耗时的部分。对于一个项目的开发，大致的时间占比如下：

![图片](https://mmbiz.qpic.cn/sz_mmbiz_png/sYwOgQTpxzIiat3SmHyALqWpILYpwoXbfL3MgavLiayIibvgNYII8rbQpFw7HqqfR4zZZjZCMEiawahBoSLjOMtChA/640?wx_fmt=png\&from=appmsg\&tp=webp\&wxfrom=5\&wx_lazy=1\&wx_co=1)

通常编写代码只占整个开发流程的大约 25% 的时间，而调试和修复 bug 往往更为困难。我们需要不断地进行调试和部署。具有较多依赖的模块相较于少依赖的模块，调试起来要困难得多。

## 我们平时使用各种框架，基础算法库都要自己写一份吗？你不也说了软件的价值不就是复用吗？

我们平时会使用各种编程语言（Java，Go），框架，库，对于这些肯定不需要自己再写一份。AWS ，各种 SaaS ，Linux ，还有制定的各种 ISO 标准都必须被复用，否则他们的存在就没有了意义。复用这些没有任何问题，因为这是共识和标准，它们足够「通用，一般化」，它们并不是为了某个业务或者某个公司定制的。但是我们需要知道复用基础软件并不代表你写的函数都值得被复用，都能被复用。

## 你的代码不值得复用，复用不是目标！

复用不是我们写的代码要追求的目标。很多工程师认为更多模块的「复用」，就可以做到像乐高一样快速搭建各式各样系统。但实际上，许多复用更像器官移植，无法提高效率，反而需要不断「应对」排异反应，降低了开发速度和稳定性。许多系统腐败的主要问题正是源自过度强调复用。

* 强行复用复杂数据表：上百个字段的订单表，没人清楚哪个字段在哪个场景下有效，数据结构隐藏在代码里，难以维护。

* 大量小微服务：抽象出来无数个小的微服务，因为服务越小越能被复用。按照这个逻辑走下去，服务往往会变成对于数据的 CRUD，然后搞个统一的编排引擎编排这些「傻服务」，然后再抽象一套 DSL 来使用编排引擎；结果是代码不知道写到哪个模块；上线极其复杂，需要按照先后顺序发布 N 个模块；调度模块是也成了系统的大单点，稳定性和迭代速度都是问题。

* 名字驱动的设计：例如订单中台、电商中台等，这样复用中台能力。实际上是各部门之间的不断扯皮、甩锅。

所谓的架构师拿着「复用」锤子，然后满眼都是钉子，不问是啥就乱砸一气。实际上，这是在打着技术卓越（毕竟在讲复用了）的名义，不定义问题和随意归因，来给自己的简历添砖加瓦。图灵奖得主 Butler Lampson 的《Hints for Computer System Design》写到

> Use a good idea again instead of generalizing it. A specialized implementation of the idea may be much more effective than a general one.

这个建议十分值得参考。

## 什么时候需要复用呢？

一般有两个目的

* 必须保持一致的逻辑：团队内达成一致，必须要使用同一模块的。例如要使用同一个 PRC 框架，使用同一个 UI 组件，同一种错误处理方式。在业务逻辑中，如果多个业务模块的某些部分总是需要一起改变，那么就必须将这些部分抽象成一个公共模块。例如 B 端和 C 端必须保持一致的数据校验，订单的价格计算逻辑。

* 提高编码效率：编码时发现一段代码恰好可以使用，不用自己再写一遍，这样可以节省一部分工作量，提高效率。例如一些工具函数。这类代码并未在团队内达成必须在相同逻辑中使用的共识，只是你恰好碰到能节省你写代码的时间。

上边两种场景中「必须保持一致的逻辑」 是必须要复用的，否则就会导致维护成本的提高，引发 bug。对于「提高编码效率」，如果片段代码正好完全符合你的意图复用也无妨（阅读和维护这段代码要花时间），但是如果只是相似并不完全适用于你的场景，就不要复用了自己再写一个吧。

## 你说「复用」并不是系统设计目标，那系统设计好的标准是什么？

两个评价标准自治性和一致性

* 自治性：一个模块受其他模块影响的程度越少，其自治性就越强。理想情况下，模块之间没有任何接口依赖，但现实的业务往往并非如此。我们可以通过衡量接口的稳定性来评估自治性。在《A Philosophy of Software Design》一书中，提出了「Modules should be deep」的观点，这让人们将注意力集中在了静态结构上。然而，核心要点在于，如果接口比实现小很多，那么接口被修改的可能性也会大大降低。这样，我们大部分时间就可以仅修改实现，而无需改动接口。

* 一致性：应该复用的地方必须复用，保持系统的必要的一致。通过接入次数，接入率等指标进行衡量。

如果一个系统在「自治性」和「一致性」方面都做得很好，那么你的系统设计应该就已经相当出色了。然而，架构设计并非数学题，总会有一些模糊地带。当你在「自治性」和「一致性」之间犹豫不决，反复思考是否要抽象模块以保持一致性时，我建议你首先考虑各模块的「自治性」，然后再考虑「一致性」。

## 总结

系统的核心复杂度不会减少， 只是转移；复杂度的主要来源就是各模块之间的交互，而且人与人之间的交互是最复杂，不可靠的。我们深知所有代码一个人写不会比分成两个人写更快，「分工，复用」是应该且必须的。分工就会产生模块之间的交互，增加人与人之间的沟通，「自治性」和「一致性」的实质就是想尽一切办法减少沟通，合理复用。

希望在你负责的系统中，不会再有人以「复用」的名义出现无数个 CRUD 的微服务，上百个字段的 MySQL 表，有十个参数的 UI 组件，奇葩的 DSL。不要让「复用」真得变成了邪恶的化身。

**如果上文对你稍微有一点儿帮助，欢迎来 [打开引擎盖]() 进行深入探讨**


  